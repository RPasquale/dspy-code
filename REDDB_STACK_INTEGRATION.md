# RedDB Stack Integration Guide

## 🚀 **RedDB is now fully integrated into your DSPy stack!**

RedDB will automatically start up when you build and run your Docker stack, providing secure, persistent storage for your agent's knowledge base.

## 📋 **What's Been Added**

### 1. **Docker Compose Integration**
- RedDB service added to `docker/lightweight/docker-compose.yml`
- Secure configuration with authentication
- Health checks and dependency management
- Resource limits and security hardening

### 2. **Environment Configuration**
- Automatic token generation in Makefile
- Secure environment variable handling
- RedDB URL configured for Docker network (`http://reddb:8080`)

### 3. **Build System Updates**
- `make stack-env` now includes RedDB configuration
- `make health-check` includes RedDB health monitoring
- Integrated startup script: `start_stack_with_reddb.sh`

## 🏗️ **How to Use**

### **Option 1: Use Existing Makefile Commands**
```bash
# Set up environment (includes RedDB)
make stack-env

# Build the stack (includes RedDB)
make stack-build

# Start the stack (includes RedDB)
make stack-up

# Check health (includes RedDB)
make health-check

# View logs
make stack-logs

# Stop the stack
make stack-down
```

### **Option 2: Use Integrated Startup Script**
```bash
# One-command startup with RedDB
./start_stack_with_reddb.sh
```

## 🔧 **RedDB Configuration**

### **Automatic Setup**
- **Token**: Automatically generated 64-character hex token
- **URL**: `http://reddb:8080` (Docker network)
- **Namespace**: `dspy`
- **Backend**: Set to `reddb` for agent

### **Environment Variables**
```bash
REDDB_ADMIN_TOKEN=<auto-generated>
REDDB_URL=http://reddb:8080
REDDB_NAMESPACE=dspy
REDDB_TOKEN=<same as admin token>
DB_BACKEND=reddb
```

## 🔒 **Security Features**

### **Container Security**
- No new privileges
- Read-only filesystem
- Dropped capabilities
- Resource limits (1GB RAM, 1 CPU)

### **Network Security**
- Bound to localhost only (`127.0.0.1:8080`)
- Internal Docker network communication
- Bearer token authentication required

### **Data Persistence**
- Persistent volume: `reddb_data`
- Data survives container restarts
- Secure token-based access

## 🧪 **Testing RedDB Integration**

### **Health Check**
```bash
# Check RedDB health
curl -H "Authorization: Bearer $REDDB_ADMIN_TOKEN" http://127.0.0.1:8080/health
```

### **Test Ingest**
```bash
curl -X POST http://127.0.0.1:8080/api/db/ingest \
  -H 'Content-Type: application/json' \
  -H "Authorization: Bearer $REDDB_ADMIN_TOKEN" \
  -d '{"kind":"document","namespace":"dspy","collection":"test","id":"test1","text":"Test document"}'
```

### **Test Query**
```bash
curl -X POST http://127.0.0.1:8080/api/db/query \
  -H 'Content-Type: application/json' \
  -H "Authorization: Bearer $REDDB_ADMIN_TOKEN" \
  -d '{"mode":"auto","namespace":"dspy","text":"test query","top_k":3}'
```

### **Agent CLI Testing**
```bash
# Test agent datasearch (when agent is running)
dspy-code datasearch "your query" --ns dspy --top-k 5
```

## 📊 **Monitoring**

### **Service Status**
```bash
# View all services
make stack-ps

# View RedDB logs
docker logs reddb-stack

# View all logs
make stack-logs
```

### **Health Monitoring**
```bash
# Comprehensive health check
make health-check

# Individual service checks
curl http://127.0.0.1:8080/health  # RedDB
curl http://127.0.0.1:8765/health # Agent
curl http://127.0.0.1:18081/api/status # Dashboard
```

## 🔄 **Development Workflow**

### **Start Development**
```bash
# Start everything with RedDB
./start_stack_with_reddb.sh

# Or use make commands
make stack-up
```

### **Code Changes**
```bash
# Reload agent after code changes
make stack-reload
```

### **Testing**
```bash
# Run tests
make test-lightweight

# Run smoke tests
make smoke
```

## 🛠️ **Troubleshooting**

### **RedDB Not Starting**
```bash
# Check RedDB logs
docker logs reddb-stack

# Check environment
cat docker/lightweight/.env

# Restart RedDB
docker restart reddb-stack
```

### **Authentication Issues**
```bash
# Check token
grep REDDB_ADMIN_TOKEN docker/lightweight/.env

# Regenerate token
export REDDB_ADMIN_TOKEN=$(openssl rand -hex 32)
```

### **Connection Issues**
```bash
# Check network
docker network ls
docker network inspect lightweight_default

# Check service discovery
docker exec -it reddb-stack nslookup reddb
```

## 📁 **File Structure**

```
docker/lightweight/
├── docker-compose.yml          # Updated with RedDB service
├── .env                        # Auto-generated with RedDB config
└── ...

# RedDB Integration Files
├── start_stack_with_reddb.sh   # Integrated startup script
├── REDDB_STACK_INTEGRATION.md  # This guide
├── REDDB_SECURITY_GUIDE.md     # Security documentation
└── docker/
    ├── reddb-secure.yml        # Standalone RedDB config
    └── nginx-reddb.conf        # Nginx proxy config
```

## 🚨 **Important Notes**

### **Security**
- **Never commit** `REDDB_ADMIN_TOKEN` to version control
- Token is automatically generated and stored in `.env`
- All API calls require Bearer token authentication

### **Data Persistence**
- RedDB data is stored in Docker volume `reddb_data`
- Data persists across container restarts
- To reset data: `docker volume rm lightweight_reddb_data`

### **Network Access**
- RedDB is accessible at `http://127.0.0.1:8080` from host
- Agent connects via `http://reddb:8080` (Docker network)
- External access requires proper authentication

## 🎯 **Next Steps**

1. **Start the stack**: `./start_stack_with_reddb.sh`
2. **Verify health**: `make health-check`
3. **Test integration**: Use the test commands above
4. **Develop**: Your agent now has persistent RedDB storage!

---

**🎉 RedDB is now fully integrated into your DSPy stack and will start automatically when you build and run your system!**
