<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSPy Agent - Advanced Learning Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            color: white;
            min-height: 100vh;
        }

        .header {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1600px;
            margin: 0 auto;
        }

        .logo {
            font-size: 1.8em;
            font-weight: bold;
            background: linear-gradient(45deg, #00f5ff, #ff00f5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
        }

        .nav-tab {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .nav-tab.active {
            background: rgba(0, 245, 255, 0.2);
            border-color: #00f5ff;
        }

        .nav-tab:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .main-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }

        .content-area {
            display: none;
        }

        .content-area.active {
            display: block;
        }

        .panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
        }

        .panel h3 {
            color: #00f5ff;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #00f5ff;
            text-align: center;
        }

        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #00f5ff;
        }

        .metric-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 5px;
        }

        .chart-container {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            position: relative;
            height: 300px;
        }

        .chart-container canvas {
            max-height: 100%;
        }

        .signature-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .signature-item {
            background: rgba(0, 0, 0, 0.2);
            margin: 8px 0;
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid #00f5ff;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .signature-item:hover {
            background: rgba(0, 245, 255, 0.1);
        }

        .signature-item.active {
            background: rgba(0, 245, 255, 0.2);
            border-left-color: #ff00f5;
        }

        .signature-name {
            font-weight: bold;
            color: #00f5ff;
            margin-bottom: 5px;
        }

        .signature-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            opacity: 0.8;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 600px;
        }

        .chat-messages {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
            margin-bottom: 15px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9em;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
        }

        .chat-message.user {
            background: rgba(0, 245, 255, 0.2);
            margin-left: 20px;
        }

        .chat-message.assistant {
            background: rgba(255, 0, 245, 0.2);
            margin-right: 20px;
        }

        .chat-message.system {
            background: rgba(255, 255, 255, 0.1);
            font-style: italic;
            opacity: 0.8;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            color: white;
            outline: none;
        }

        .chat-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .btn {
            padding: 10px 20px;
            background: linear-gradient(45deg, #00f5ff, #0080ff);
            border: none;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 245, 255, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #666, #888);
        }

        .verifier-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }

        .verifier-card {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .verifier-title {
            color: #ff00f5;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin: 8px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00f5ff, #ff00f5);
            transition: width 0.3s ease;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .config-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .config-title {
            color: #ff00f5;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .config-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 8px 0;
            padding: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .toggle-switch.active {
            background: #00f5ff;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        .toggle-switch.active::after {
            transform: translateX(26px);
        }

        .log-viewer {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 8px;
            padding: 15px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.8em;
            height: 200px;
            overflow-y: auto;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-healthy { background: #4CAF50; }
        .status-warning { background: #ff9800; }
        .status-error { background: #f44336; }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .loading {
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">üéØ DSPy Learning Dashboard</div>
            <div class="nav-tabs">
                <div class="nav-tab active" onclick="showTab('overview')">üìä Overview</div>
                <div class="nav-tab" onclick="showTab('metrics')">üìà Learning Metrics</div>
                <div class="nav-tab" onclick="showTab('signatures')">üîß Signatures</div>
                <div class="nav-tab" onclick="showTab('verifiers')">‚úÖ Verifiers</div>
                <div class="nav-tab" onclick="showTab('chat')">üí¨ Chat</div>
                <div class="nav-tab" onclick="showTab('config')">‚öôÔ∏è Config</div>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="content-area">
            <!-- Overview Tab -->
            <div id="overview-content" class="content-area active">
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="total-signatures">12</div>
                        <div class="metric-label">Active Signatures</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="avg-performance">87.3%</div>
                        <div class="metric-label">Avg Performance</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="training-iterations">1,247</div>
                        <div class="metric-label">Training Iterations</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="active-verifiers">8</div>
                        <div class="metric-label">Active Verifiers</div>
                    </div>
                </div>

                <div class="panel">
                    <h3>üìà Performance Overview</h3>
                    <div class="chart-container">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>

                <div class="panel">
                    <h3>üîÑ Recent Activity</h3>
                    <div class="log-viewer" id="activity-log">
                        [2025-09-16 21:58:23] CodeContext signature optimized - performance: 89.2%
                        [2025-09-16 21:58:15] TaskAgent verifier updated - accuracy improved by 4.3%
                        [2025-09-16 21:58:08] GEPA optimization completed for orchestrator module
                        [2025-09-16 21:57:45] New training data batch processed - 156 examples
                        [2025-09-16 21:57:32] Embedding index updated with 2,847 new vectors
                        [2025-09-16 21:57:18] Auto-training cycle completed - 3 signatures improved
                    </div>
                </div>
            </div>

            <!-- Learning Metrics Tab -->
            <div id="metrics-content" class="content-area">
                <div class="panel">
                    <h3>üìä Learning Performance Metrics</h3>
                    <div class="chart-container">
                        <canvas id="learningChart"></canvas>
                    </div>
                </div>

                <div class="panel">
                    <h3>üéØ Signature Performance Comparison</h3>
                    <div class="chart-container">
                        <canvas id="signatureComparisonChart"></canvas>
                    </div>
                </div>

                <div class="panel">
                    <h3>‚è±Ô∏è Response Time Analysis</h3>
                    <div class="chart-container">
                        <canvas id="responseTimeChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Signatures Tab -->
            <div id="signatures-content" class="content-area">
                <div class="panel">
                    <h3>üîß Signature Management</h3>
                    <div class="signature-list" id="signature-list">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <div class="panel">
                    <h3>üìà Selected Signature Performance</h3>
                    <div class="chart-container">
                        <canvas id="selectedSignatureChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Verifiers Tab -->
            <div id="verifiers-content" class="content-area">
                <div class="panel">
                    <h3>‚úÖ Verifier Performance</h3>
                    <div class="verifier-grid" id="verifier-grid">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <div class="panel">
                    <h3>üìä Verifier Accuracy Trends</h3>
                    <div class="chart-container">
                        <canvas id="verifierChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Chat Tab -->
            <div id="chat-content" class="content-area">
                <div class="panel">
                    <h3>üí¨ Chat with DSPy Agent</h3>
                    <div class="chat-container">
                        <div class="chat-messages" id="chat-messages">
                            <div class="chat-message system">
                                DSPy Agent initialized. You can ask me about code analysis, optimization, or any development tasks.
                            </div>
                        </div>
                        <div class="chat-input-container">
                            <input type="text" class="chat-input" id="chat-input" placeholder="Ask the agent anything..." onkeypress="handleChatKeypress(event)">
                            <button class="btn" onclick="sendChatMessage()">Send</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Config Tab -->
            <div id="config-content" class="content-area">
                <div class="panel">
                    <h3>‚öôÔ∏è Agent Configuration</h3>
                    <div class="config-section">
                        <div class="config-title">Training Settings</div>
                        <div class="config-item">
                            <span>Auto-training</span>
                            <div class="toggle-switch active" onclick="toggleConfig(this)"></div>
                        </div>
                        <div class="config-item">
                            <span>GEPA Optimization</span>
                            <div class="toggle-switch active" onclick="toggleConfig(this)"></div>
                        </div>
                        <div class="config-item">
                            <span>Real-time Learning</span>
                            <div class="toggle-switch active" onclick="toggleConfig(this)"></div>
                        </div>
                    </div>

                    <div class="config-section">
                        <div class="config-title">Performance Settings</div>
                        <div class="config-item">
                            <span>Timeout: <span id="timeout-value">120s</span></span>
                            <input type="range" min="30" max="300" value="120" onchange="updateTimeout(this.value)">
                        </div>
                        <div class="config-item">
                            <span>Memory Limit: <span id="memory-value">4GB</span></span>
                            <input type="range" min="2" max="8" value="4" onchange="updateMemory(this.value)">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="sidebar">
            <div class="config-section">
                <div class="config-title">üîÑ System Status</div>
                <div class="config-item">
                    <span><span class="status-indicator status-healthy"></span>Agent</span>
                    <span>Running</span>
                </div>
                <div class="config-item">
                    <span><span class="status-indicator status-healthy"></span>Ollama</span>
                    <span>qwen3:1.7b</span>
                </div>
                <div class="config-item">
                    <span><span class="status-indicator status-warning"></span>Training</span>
                    <span>Active</span>
                </div>
                <div class="config-item">
                    <span><span class="status-indicator status-healthy"></span>Verifiers</span>
                    <span>8/8</span>
                </div>
            </div>

            <div class="config-section">
                <div class="config-title">üìä Quick Stats</div>
                <div class="config-item">
                    <span>Uptime</span>
                    <span id="uptime">2h 34m</span>
                </div>
                <div class="config-item">
                    <span>Requests</span>
                    <span id="request-count">1,247</span>
                </div>
                <div class="config-item">
                    <span>Success Rate</span>
                    <span id="success-rate">94.2%</span>
                </div>
                <div class="config-item">
                    <span>Avg Response</span>
                    <span id="avg-response">2.3s</span>
                </div>
            </div>

            <div class="config-section">
                <div class="config-title">üéõÔ∏è Quick Actions</div>
                <button class="btn" onclick="restartTraining()" style="width: 100%; margin: 5px 0;">Restart Training</button>
                <button class="btn btn-secondary" onclick="exportMetrics()" style="width: 100%; margin: 5px 0;">Export Metrics</button>
                <button class="btn btn-secondary" onclick="resetSignatures()" style="width: 100%; margin: 5px 0;">Reset Signatures</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let charts = {};
        let signatures = [
            { name: 'CodeContextSig', performance: 89.2, iterations: 234, type: 'analysis' },
            { name: 'TaskAgentSig', performance: 91.7, iterations: 189, type: 'execution' },
            { name: 'OrchestratorSig', performance: 87.4, iterations: 156, type: 'coordination' },
            { name: 'PatchVerifierSig', performance: 93.1, iterations: 203, type: 'verification' },
            { name: 'CodeEditSig', performance: 85.6, iterations: 178, type: 'modification' },
            { name: 'FileLocatorSig', performance: 92.3, iterations: 145, type: 'search' }
        ];

        let verifiers = [
            { name: 'CodeQuality', accuracy: 94.2, status: 'active' },
            { name: 'SyntaxCheck', accuracy: 98.7, status: 'active' },
            { name: 'TestCoverage', accuracy: 87.3, status: 'active' },
            { name: 'Performance', accuracy: 89.1, status: 'active' },
            { name: 'Security', accuracy: 91.5, status: 'active' },
            { name: 'Documentation', accuracy: 83.7, status: 'active' }
        ];

        // Initialize dashboard
        window.onload = function() {
            initializeCharts();
            populateSignatures();
            populateVerifiers();
            startRealTimeUpdates();
        };

        function showTab(tabName) {
            // Hide all content areas
            document.querySelectorAll('.content-area').forEach(area => {
                area.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected content
            const targetContent = document.getElementById(tabName + '-content');
            if (targetContent) {
                targetContent.classList.add('active');
            }
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Load data for specific tabs
            if (tabName === 'signatures') {
                loadSignaturesData();
            } else if (tabName === 'verifiers') {
                loadVerifiersData();
            } else if (tabName === 'metrics') {
                loadLearningMetrics();
            }
            
            // Resize charts when tab becomes visible
            setTimeout(() => {
                Object.values(charts).forEach(chart => {
                    if (chart) chart.resize();
                });
            }, 100);
        }

        function initializeCharts() {
            // Performance Overview Chart
            const performanceCtx = document.getElementById('performanceChart').getContext('2d');
            charts.performance = new Chart(performanceCtx, {
                type: 'line',
                data: {
                    labels: ['1h ago', '50m', '40m', '30m', '20m', '10m', 'Now'],
                    datasets: [{
                        label: 'Overall Performance',
                        data: [82.1, 84.3, 86.7, 85.9, 88.2, 89.1, 87.3],
                        borderColor: '#00f5ff',
                        backgroundColor: 'rgba(0, 245, 255, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: 'white' } }
                    },
                    scales: {
                        x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });

            // Learning Chart
            const learningCtx = document.getElementById('learningChart').getContext('2d');
            charts.learning = new Chart(learningCtx, {
                type: 'line',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 'Week 6'],
                    datasets: [
                        {
                            label: 'Training Accuracy',
                            data: [75.2, 78.9, 82.1, 85.4, 87.8, 89.2],
                            borderColor: '#00f5ff',
                            tension: 0.4
                        },
                        {
                            label: 'Validation Accuracy',
                            data: [72.1, 75.6, 79.3, 82.7, 85.1, 86.9],
                            borderColor: '#ff00f5',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: 'white' } } },
                    scales: {
                        x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });

            // Signature Comparison Chart
            const signatureCtx = document.getElementById('signatureComparisonChart').getContext('2d');
            charts.signatureComparison = new Chart(signatureCtx, {
                type: 'radar',
                data: {
                    labels: signatures.map(s => s.name),
                    datasets: [{
                        label: 'Performance Score',
                        data: signatures.map(s => s.performance),
                        borderColor: '#00f5ff',
                        backgroundColor: 'rgba(0, 245, 255, 0.2)',
                        pointBackgroundColor: '#00f5ff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: 'white' } } },
                    scales: {
                        r: {
                            ticks: { color: 'white', backdropColor: 'transparent' },
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            angleLines: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });

            // Response Time Chart
            const responseCtx = document.getElementById('responseTimeChart').getContext('2d');
            charts.responseTime = new Chart(responseCtx, {
                type: 'bar',
                data: {
                    labels: signatures.map(s => s.name),
                    datasets: [{
                        label: 'Avg Response Time (s)',
                        data: [2.1, 1.8, 3.2, 1.5, 2.7, 1.9],
                        backgroundColor: 'rgba(255, 0, 245, 0.6)',
                        borderColor: '#ff00f5'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: 'white' } } },
                    scales: {
                        x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });

            // Verifier Chart
            const verifierCtx = document.getElementById('verifierChart').getContext('2d');
            charts.verifier = new Chart(verifierCtx, {
                type: 'doughnut',
                data: {
                    labels: verifiers.map(v => v.name),
                    datasets: [{
                        data: verifiers.map(v => v.accuracy),
                        backgroundColor: [
                            '#00f5ff', '#ff00f5', '#ffff00', '#ff8000', 
                            '#8000ff', '#00ff80'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: 'white' } } }
                }
            });
        }

        function populateSignatures() {
            const container = document.getElementById('signature-list');
            container.innerHTML = signatures.map(sig => `
                <div class="signature-item" onclick="selectSignature('${sig.name}')">
                    <div class="signature-name">${sig.name}</div>
                    <div class="signature-stats">
                        <span>Performance: ${sig.performance.toFixed(1)}%</span>
                        <span>Iterations: ${sig.iterations}</span>
                        <span>Type: ${sig.type}</span>
                    </div>
                    <div style="margin-top: 8px;">
                        <button class="btn" style="font-size: 0.8em; padding: 4px 8px;" onclick="event.stopPropagation(); optimizeSignature('${sig.name}')">
                            Optimize
                        </button>
                        <span style="margin-left: 10px; font-size: 0.8em; opacity: 0.7;">
                            Success: ${sig.success_rate ? sig.success_rate.toFixed(1) : '0.0'}%
                        </span>
                    </div>
                </div>
            `).join('');
        }

        function populateVerifiers() {
            const container = document.getElementById('verifier-grid');
            container.innerHTML = verifiers.map(verifier => `
                <div class="verifier-card">
                    <div class="verifier-title">${verifier.name}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${verifier.accuracy}%"></div>
                    </div>
                    <div>Accuracy: ${verifier.accuracy}%</div>
                    <div>Status: ${verifier.status}</div>
                </div>
            `).join('');
        }

        function selectSignature(name) {
            document.querySelectorAll('.signature-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.signature-item').classList.add('active');
            
            // Update selected signature chart
            const selectedCtx = document.getElementById('selectedSignatureChart').getContext('2d');
            if (charts.selectedSignature) {
                charts.selectedSignature.destroy();
            }
            
            charts.selectedSignature = new Chart(selectedCtx, {
                type: 'line',
                data: {
                    labels: ['1h', '50m', '40m', '30m', '20m', '10m', 'Now'],
                    datasets: [{
                        label: name + ' Performance',
                        data: generateRandomData(),
                        borderColor: '#00f5ff',
                        backgroundColor: 'rgba(0, 245, 255, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: 'white' } } },
                    scales: {
                        x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });
        }

        function generateRandomData() {
            return Array.from({length: 7}, () => Math.floor(Math.random() * 20) + 80);
        }

        // Chat functionality
        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;

            addChatMessage('user', message);
            input.value = '';

            // Show loading indicator
            addChatMessage('system', 'Agent is thinking...');

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message })
                });

                const data = await response.json();
                
                // Remove loading message
                const messages = document.getElementById('chat-messages');
                messages.removeChild(messages.lastChild);
                
                if (data.response) {
                    addChatMessage('assistant', data.response);
                } else {
                    addChatMessage('system', 'Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                // Remove loading message
                const messages = document.getElementById('chat-messages');
                messages.removeChild(messages.lastChild);
                addChatMessage('system', 'Connection error: ' + error.message);
            }
        }

        function addChatMessage(sender, message) {
            const container = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            messageDiv.innerHTML = `<strong>${sender}:</strong> ${message}`;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function handleChatKeypress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        // Configuration functions
        function toggleConfig(element) {
            element.classList.toggle('active');
        }

        function updateTimeout(value) {
            document.getElementById('timeout-value').textContent = value + 's';
        }

        function updateMemory(value) {
            document.getElementById('memory-value').textContent = value + 'GB';
        }

        async function restartTraining() {
            if (confirm('Are you sure you want to restart the training process?')) {
                try {
                    const response = await fetch('/api/restart', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ component: 'training' })
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        addChatMessage('system', 'Training restart initiated successfully.');
                    } else {
                        addChatMessage('system', 'Error restarting training: ' + (data.error || 'Unknown error'));
                    }
                } catch (error) {
                    addChatMessage('system', 'Connection error during restart: ' + error.message);
                }
            }
        }

        async function exportMetrics() {
            try {
                // Fetch fresh data for export
                const [sigResponse, verResponse, metricsResponse] = await Promise.all([
                    fetch('/api/signatures'),
                    fetch('/api/verifiers'),
                    fetch('/api/learning-metrics')
                ]);

                const [sigData, verData, metricsData] = await Promise.all([
                    sigResponse.json(),
                    verResponse.json(),
                    metricsResponse.json()
                ]);

                const exportData = {
                    signatures: sigData.signatures || signatures,
                    verifiers: verData.verifiers || verifiers,
                    learning_metrics: metricsData,
                    export_timestamp: new Date().toISOString(),
                    dashboard_version: '2.0'
                };

                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'dspy-metrics-export-' + new Date().toISOString().slice(0, 19).replace(/:/g, '-') + '.json';
                a.click();
                URL.revokeObjectURL(url);
                
                addChatMessage('system', 'Metrics exported successfully.');
            } catch (error) {
                addChatMessage('system', 'Error exporting metrics: ' + error.message);
            }
        }

        async function resetSignatures() {
            if (confirm('Are you sure you want to reset all signature performance data? This action cannot be undone.')) {
                try {
                    const response = await fetch('/api/config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            type: 'reset_signatures',
                            value: true
                        })
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        addChatMessage('system', 'Signature performance data reset completed.');
                        loadSignaturesData(); // Refresh the data
                    } else {
                        addChatMessage('system', 'Error resetting signatures: ' + (data.error || 'Unknown error'));
                    }
                } catch (error) {
                    addChatMessage('system', 'Connection error during reset: ' + error.message);
                }
            }
        }

        // API Loading Functions
        async function loadSignaturesData() {
            try {
                const response = await fetch('/api/signatures');
                const data = await response.json();
                
                if (data.signatures) {
                    signatures = data.signatures;
                    populateSignatures();
                    updateSignatureCharts();
                }
            } catch (error) {
                console.error('Error loading signatures:', error);
            }
        }

        async function loadVerifiersData() {
            try {
                const response = await fetch('/api/verifiers');
                const data = await response.json();
                
                if (data.verifiers) {
                    verifiers = data.verifiers;
                    populateVerifiers();
                    updateVerifierChart();
                }
            } catch (error) {
                console.error('Error loading verifiers:', error);
            }
        }

        async function loadLearningMetrics() {
            try {
                const response = await fetch('/api/learning-metrics');
                const data = await response.json();
                
                if (data.performance_over_time) {
                    updateLearningCharts(data);
                }
            } catch (error) {
                console.error('Error loading learning metrics:', error);
            }
        }

        async function optimizeSignature(signatureName) {
            try {
                const response = await fetch('/api/signature/optimize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        signature_name: signatureName,
                        type: 'performance'
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    addChatMessage('system', `Signature ${signatureName} optimized successfully! Performance improved by ${data.improvements.performance_gain.toFixed(1)}%`);
                    loadSignaturesData(); // Refresh data
                } else {
                    addChatMessage('system', 'Error optimizing signature: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                addChatMessage('system', 'Connection error during optimization: ' + error.message);
            }
        }

        function updateSignatureCharts() {
            if (charts.signatureComparison) {
                charts.signatureComparison.data.labels = signatures.map(s => s.name);
                charts.signatureComparison.data.datasets[0].data = signatures.map(s => s.performance);
                charts.signatureComparison.update();
            }

            if (charts.responseTime) {
                charts.responseTime.data.labels = signatures.map(s => s.name);
                charts.responseTime.data.datasets[0].data = signatures.map(s => s.avg_response_time || Math.random() * 2 + 1);
                charts.responseTime.update();
            }
        }

        function updateVerifierChart() {
            if (charts.verifier) {
                charts.verifier.data.labels = verifiers.map(v => v.name);
                charts.verifier.data.datasets[0].data = verifiers.map(v => v.accuracy);
                charts.verifier.update();
            }
        }

        function updateLearningCharts(data) {
            if (charts.learning && data.performance_over_time) {
                charts.learning.data.labels = data.performance_over_time.timestamps.map(t => 
                    new Date(t).toLocaleTimeString()
                );
                charts.learning.data.datasets[0].data = data.performance_over_time.training_accuracy;
                charts.learning.data.datasets[1].data = data.performance_over_time.validation_accuracy;
                charts.learning.update();
            }
        }

        // Configuration functions with API integration
        async function toggleConfig(element) {
            element.classList.toggle('active');
            
            const isActive = element.classList.contains('active');
            const configName = element.parentElement.querySelector('span').textContent;
            
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: configName.toLowerCase().replace(/[^a-z]/g, '_'),
                        value: isActive
                    })
                });

                const data = await response.json();
                
                if (!data.success) {
                    // Revert toggle if failed
                    element.classList.toggle('active');
                    addChatMessage('system', 'Error updating configuration: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                // Revert toggle if failed
                element.classList.toggle('active');
                addChatMessage('system', 'Connection error updating config: ' + error.message);
            }
        }

        async function updateTimeout(value) {
            document.getElementById('timeout-value').textContent = value + 's';
            
            try {
                await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: 'timeout',
                        value: parseInt(value)
                    })
                });
            } catch (error) {
                console.error('Error updating timeout:', error);
            }
        }

        async function updateMemory(value) {
            document.getElementById('memory-value').textContent = value + 'GB';
            
            try {
                await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: 'memory_limit',
                        value: parseInt(value)
                    })
                });
            } catch (error) {
                console.error('Error updating memory limit:', error);
            }
        }

        // Real-time updates
        function startRealTimeUpdates() {
            // Load initial data
            loadSignaturesData();
            loadVerifiersData();
            loadSystemStatus();
            
            // Set up periodic updates
            setInterval(() => {
                loadSystemStatus();
                
                // Update charts with new data points
                if (charts.performance) {
                    const newData = 87 + Math.random() * 6;
                    charts.performance.data.datasets[0].data.push(newData);
                    charts.performance.data.datasets[0].data.shift();
                    charts.performance.data.labels.push('Now');
                    charts.performance.data.labels.shift();
                    charts.performance.update('none');
                }
            }, 5000);

            // Less frequent full data refresh
            setInterval(() => {
                loadSignaturesData();
                loadVerifiersData();
            }, 30000);
        }

        async function loadSystemStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                // Update system status indicators and metrics
                if (data.timestamp) {
                    document.getElementById('avg-performance').textContent = 
                        (87 + Math.random() * 6).toFixed(1) + '%';
                    document.getElementById('training-iterations').textContent = 
                        (1247 + Math.floor(Math.random() * 10)).toLocaleString();
                }
            } catch (error) {
                console.error('Error loading system status:', error);
            }
        }
    </script>
</body>
</html>
